<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Next Livestream</title>

<!-- PT Sans -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">

<style>
html, body {
  font-family: 'PT Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  font-size: 16px;
  line-height: 1.5;
  color: #333;
  background: #fff;
  margin: 0;
}

a { color: #005398; text-decoration: none; }
a:hover { text-decoration: underline; }

.container {
  max-width: 640px;
  margin: 0 auto;
  padding: 0.75rem;
  max-height: 100%;
  overflow-y: auto;
  box-sizing: border-box;
}

.stream {
  border: 1px solid #ddd;
  border-radius: 4px;
  overflow: hidden;
  background: #fafafa;
}

.stream img {
  width: 100%;
  height: auto;
  max-height: 280px;
  object-fit: cover;
}

.content { padding: 0.65rem; }

.title { font-weight: 700; margin-bottom: 0.25rem; }
.date { font-size: 0.9rem; color: #555; }

.countdown {
  margin-top: 0.25rem;
  font-size: 0.95rem;
  font-weight: 700;
}

.countdown.live { color: #cc0000; }

.description {
  margin-top: 0.4rem;
  font-size: 0.9rem;
}

.calendar {
  margin-top: 0.4rem;
  font-size: 0.85rem;
}

.calendar a { margin-right: 0.75rem; }

.watch-live { margin-top: 0.6rem; }

.watch-live a {
  display: inline-block;
  background: #cc0000;
  color: #fff;
  padding: 0.45rem 0.7rem;
  font-weight: 700;
  border-radius: 3px;
}

.watch-live a:hover { background: #a30000; }

.none { font-style: italic; color: #666; }
</style>
</head>

<body>

<div class="container" id="output">
  Loading next livestream…
</div>

<script>
const API_KEY = "AIzaSyDvflaf2WrXoTPnj1-cDHYWhCD_pMJnhoY";
const CHANNEL_ID = "UC7Do00lxLh7l4WwXLl96P5A";
const TIMEZONE = "Europe/London";
const DESCRIPTION_LIMIT = 220;
const TEST_MODE = true;

function formatUKDate(iso) {
  return new Date(iso).toLocaleString("en-GB", {
    dateStyle: "medium",
    timeStyle: "short",
    timeZone: TIMEZONE
  });
}

function truncate(text, max) {
  return !text ? "" : text.length > max ? text.substring(0, max) + "…" : text;
}

function updateStatus(startISO, countdownEl, calendarEl, watchLiveEl) {
  const diff = new Date(startISO) - new Date();
  if (diff <= 0) {
    countdownEl.textContent = "LIVE NOW";
    countdownEl.classList.add("live");
    calendarEl.style.display = "none";
    watchLiveEl.style.display = "block";
    return;
  }
  const mins = Math.floor(diff / 60000);
  const hrs = Math.floor(mins / 60);
  const days = Math.floor(hrs / 24);
  countdownEl.textContent =
    days > 0 ? `Starts in ${days} day${days !== 1 ? "s" : ""}` :
    hrs > 0 ? `Starts in ${hrs} hour${hrs !== 1 ? "s" : ""}` :
    `Starts in ${mins} minute${mins !== 1 ? "s" : ""}`;
}

function startCountdown(startISO, c, cal, w) {
  updateStatus(startISO, c, cal, w);
  setInterval(() => updateStatus(startISO, c, cal, w), 60000);
}

function renderStream({ videoId, title, description, thumbnail, startTime }) {
  document.getElementById("output").innerHTML = `
  <div class="stream">
    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">
      <img src="${thumbnail}" alt="">
    </a>
    <div class="content">
      <div class="title">${title}</div>
      <div class="date">${formatUKDate(startTime)} (UK time)</div>
      <div class="countdown" id="countdown"></div>
      <div class="description">${truncate(description, DESCRIPTION_LIMIT)}</div>
      <div class="calendar" id="calendar">
        <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">View on YouTube</a>
      </div>
      <div class="watch-live" id="watchLive" style="display:none">
        <a href="https://www.youtube.com/watch?v=${videoId}&live_chat=1" target="_blank">
          ▶ Watch live on YouTube
        </a>
      </div>
    </div>
  </div>`;
  startCountdown(
    startTime,
    document.getElementById("countdown"),
    document.getElementById("calendar"),
    document.getElementById("watchLive")
  );
}

if (TEST_MODE) {
  renderStream({
    videoId: "TEST123",
    title: "Test Livestream (Dev Mode)",
    description: "Mock livestream used to test layout and responsive height behaviour in the CMS iframe.",
    thumbnail: "https://i.ytimg.com/vi/lVL8gN_APZ0/hqdefault.jpg?sqp=-oaymwEnCNACELwBSFryq4qpAxkIARUAAIhCGAHYAQHiAQoIGBACGAY4AUAB&rs=AOn4CLDWnQfwej2fiyMnKagzSn1vDHm9rQ",
    startTime: new Date(Date.now() + 10 * 60000).toISOString()
  });
}
</script>

</body>
</html>
